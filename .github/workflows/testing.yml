name: Testing - Frontend Unit & Build

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  lint:
    name: "Linting (ESLint)"
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci

      - name: üîç Run ESLint
        run: npm run lint

  unit-tests:
    name: "Unit Tests (Node 20.x)"
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci

      - name: üß™ Run unit tests
        id: test
        env:
          CI: true
          GITHUB_ACTIONS: true
        run: |
          npm run test -- --coverage 2>&1 | tee test-output.txt
          
          TEST_EXIT_CODE=$?
          echo "exit_code=${TEST_EXIT_CODE}" >> $GITHUB_OUTPUT
          
          # Extract test counts
          PASS_COUNT=$(grep -oP '\d+(?= passed)' test-output.txt | head -1 || echo "0")
          FAIL_COUNT=$(grep -oP '\d+(?= failed)' test-output.txt | head -1 || echo "0")
          echo "passed=${PASS_COUNT}" >> $GITHUB_OUTPUT
          echo "failed=${FAIL_COUNT}" >> $GITHUB_OUTPUT
          
          exit 0

      - name: üîç Debug coverage files
        if: always()
        run: |
          echo "=== Coverage Directory Contents ==="
          ls -la coverage/ 2>/dev/null || echo "‚ùå No coverage directory found"
          
          echo ""
          echo "=== Checking for coverage-final.json ==="
          if [ -f coverage/coverage-final.json ]; then
            echo "‚úÖ coverage-final.json found"
            echo "File size: $(wc -c < coverage/coverage-final.json) bytes"
          else
            echo "‚ùå coverage-final.json NOT found"
          fi

      - name: üìä Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: unit-tests
          fail_ci_if_error: false

      - name: ‚ùå Fail if tests failed
        if: steps.test.outputs.exit_code != 0
        run: exit 1

  build:
    name: "Build Verification"
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    if: always() && needs.lint.result == 'success' && needs.unit-tests.result == 'success'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: üìö Install dependencies
        run: npm ci

      - name: üî® Build project
        run: npm run build

      - name: üìä Check bundle size (if applicable)
        if: hashFiles('package.json') != ''
        run: |
          if [ -f "package.json" ] && grep -q "\"build\"" package.json; then
            echo "‚úÖ Build completed successfully"
            if [ -d "dist" ]; then
              echo "üì¶ Build output size:"
              du -sh dist/
            elif [ -d "build" ]; then
              echo "üì¶ Build output size:"
              du -sh build/
            fi
          fi

  coverage-check:
    name: "Coverage Threshold Check"
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: always() && needs.unit-tests.result == 'success'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: üìö Install dependencies
        run: npm ci

      - name: üìä Verify coverage thresholds
        run: |
          npm run test -- --coverage --silent > /dev/null 2>&1 || true
          
          # Parse coverage thresholds
          LINES=$(grep -oP 'Lines\s+:\s+\K[\d.]+' coverage/coverage-summary.json || echo "0")
          FUNCTIONS=$(grep -oP 'Functions\s+:\s+\K[\d.]+' coverage/coverage-summary.json || echo "0")
          BRANCHES=$(grep -oP 'Branches\s+:\s+\K[\d.]+' coverage/coverage-summary.json || echo "0")
          
          echo "üìä Coverage Summary (Frontend):"
          echo "   Lines:     ${LINES}% (target: 80%+)"
          echo "   Functions: ${FUNCTIONS}% (target: 85%+)"
          echo "   Branches:  ${BRANCHES}% (target: 75%+)"
          
          # Check thresholds
          if (( $(echo "$LINES < 80" | bc -l) )); then
            echo "‚ùå Lines coverage below 80% threshold"
            exit 1
          fi
          
          if (( $(echo "$FUNCTIONS < 85" | bc -l) )); then
            echo "‚ùå Functions coverage below 85% threshold"
            exit 1
          fi
          
          if (( $(echo "$BRANCHES < 75" | bc -l) )); then
            echo "‚ùå Branches coverage below 75% threshold"
            exit 1
          fi
          
          echo "‚úÖ All coverage thresholds met"
